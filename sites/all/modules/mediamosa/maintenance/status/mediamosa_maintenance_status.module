<?php
// $Id$

/**
 * MediaMosa is Open Source Software to build a Full Featured, Webservice
 * Oriented Media Management and Distribution platform (http://mediamosa.org)
 *
 * Copyright (C) 2010 SURFnet BV (http://www.surfnet.nl) and Kennisnet
 * (http://www.kennisnet.nl)
 *
 * MediaMosa is based on the open source Drupal platform and
 * was originally developed by Madcap BV (http://www.madcap.nl)
 *
 * This program is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 2 as
 * published by the Free Software Foundation.
 * This program is distributed in the hope that it will be useful, but
 * WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
 * General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License along
 * with this program; if not, you can find it at:
 * http://www.gnu.org/licenses/old-licenses/gpl-2.0.html
 */

/**
 * Constants.
 */

/**
 * Result severity -- Informational message only.
 */
define('MEDIAMOSA_MAINTENANCE_STATUS_RESULT_INFO', -1);

/**
 * Result severity -- Result successfully met.
 */
define('MEDIAMOSA_MAINTENANCE_STATUS_RESULT_OK', 0);

/**
 * Result severity -- Warning condition; proceed but flag warning.
 */
define('MEDIAMOSA_MAINTENANCE_STATUS_RESULT_WARNING', 1);

/**
 * Result severity -- Error condition; abort.
 */
define('MEDIAMOSA_MAINTENANCE_STATUS_RESULT_ERROR', 2);

/**
 * @file
 * The status module.
 */

/**
 * Implements hook_menu().
 */
function mediamosa_maintenance_status_menu() {
  $items = array();

  // Sub tabs.
  $items['admin/mediamosa/status/status'] = array(
    'title' => 'Status',
    'type' => MENU_DEFAULT_LOCAL_TASK,
    'page callback' => '_mediamosa_maintenance_status_status',
    'access arguments' => array('access mediamosa'),
    'weight' => 0,
  );
  $items['admin/mediamosa/status/server'] = array(
    'title' => 'Server',
    'type' => MENU_LOCAL_TASK,
    'page callback' => '_mediamosa_maintenance_status_server',
    'access arguments' => array('access mediamosa'),
    'weight' => 10,
  );
  $items['admin/mediamosa/status/job'] = array(
    'title' => 'Job',
    'type' => MENU_LOCAL_TASK,
    'page callback' => '_mediamosa_maintenance_status_job',
    'access arguments' => array('access mediamosa'),
    'weight' => 20,
  );
  $items['admin/mediamosa/status/job/list'] = array(
    'title' => 'Job',
    'type' => MENU_CALLBACK,
    'page callback' => '_mediamosa_maintenance_status_job_list',
    'access arguments' => array('access mediamosa'),
    'weight' => 20,
  );

  return $items;
}

/**
 * Implements hook_mediamosa_register_rest_call().
 */
function mediamosa_maintenance_status_mediamosa_register_rest_call() {

  $rest_calls = array();

  $rest_calls['status'][mediamosa_rest_call::METHOD_GET] = array(
    mediamosa_rest_call::CLASS_NAME => 'mediamosa_rest_call_status',
    mediamosa_rest_call::STATUS => mediamosa_rest_call::STATUS_ACTIVE,
    mediamosa_rest_call::MODULE_NAME => 'mediamosa',
    mediamosa_rest_call::VERSION => mediamosa_version::MEDIAMOSA_VERSION_1_1_0,
    mediamosa_rest_call::ACCESS => mediamosa_rest_call::ACCESS_FOR_EXTERNAL,
    mediamosa_rest_call::BEHAVE_AS_EXTERNAL => TRUE,
  );

  return $rest_calls;
}

/**
 * Implements hook_mediamosa_register_rest_call_doc().
 */
function mediamosa_maintenance_status_mediamosa_register_rest_call_doc() {
  $rest_calls = array();

  $rest_calls['status'][mediamosa_rest_call::METHOD_GET] = array(
    mediamosa_rest_call::TITLE => 'Retrieve the current status of MediaMosa',
    mediamosa_rest_call::DESCRIPTION => 'Retrieve the current status of MediaMosa.',
    mediamosa_rest_call::EXAMPLE_REQUEST => 'status',
    mediamosa_rest_call::RESPONSE_FIELDS => array(),
    mediamosa_rest_call::EXAMPLE_RESPONSE => '<items></items>',
  );

  return $rest_calls;
}

/**
 * Implements hook_theme().
 */
function mediamosa_maintenance_status_theme() {
  return array(
    'mediamosa_maintenance_status_report' => array(
      'arguments' => array('table_name' => NULL, 'results' => NULL),
    ),
  );
}

/**
 * Implements hook_cron().
 */
function mediamosa_maintenance_status_cron() {
  $last_time = variable_get('mediamosa_status_last_time', 0);

  if ($last_time < time() - mediamosa_settings::MAINTENANCE_STATUS_CRON_TIME) {
    variable_set('mediamosa_status_last_time', time());
    // Check run-time requirements and status information.
    module_invoke_all('mediamosa_status_generate');
  }
}

/**
 * Returns HTML for the Mediamosa status report.
 *
 * @param $table_name
 *   A string with the name of the table
 * @param $results
 *   An associative array containing:
 *   - result: An array of results.
 *     * 'title': the name of the result.
 *     * 'value': the current value.
 *     * 'description': description of the result.
 *     * 'severity': the result's severity level, one of:
 *       MEDIAMOSA_MAINTENANCE_STATUS_RESULT_INFO: For info only.
 *       MEDIAMOSA_MAINTENANCE_STATUS_RESULT_OK: The result is satisfied.
 *       MEDIAMOSA_MAINTENANCE_STATUS_RESULT_WARNING: The result failed with a warning.
 *       MEDIAMOSA_MAINTENANCE_STATUS_RESULT_ERROR: The result failed with an error.
 *
 * @ingroup themeable
 */
function theme_mediamosa_maintenance_status_report($variables) {
  drupal_add_css(drupal_get_path('module', 'mediamosa_maintenance_status') . '/mediamosa_maintenance_status.css');

  $table_name = $variables['table_name'];
  $results = $variables['results'];

  $output = '';
  $i = 0;

  $output .= $table_name;
  $output .= '<table class="system-status-report">';
  foreach ($results as $result) {
    $class = ++$i % 2 == 0 ? 'even' : 'odd';

    $classes = array(
      MEDIAMOSA_MAINTENANCE_STATUS_RESULT_INFO => 'mediamosa-status-info',
      MEDIAMOSA_MAINTENANCE_STATUS_RESULT_OK => 'mediamosa-status-ok',
      MEDIAMOSA_MAINTENANCE_STATUS_RESULT_WARNING => 'mediamosa-status-warning',
      MEDIAMOSA_MAINTENANCE_STATUS_RESULT_ERROR => 'mediamosa-status-error',
    );
    $class = $classes[isset($result['severity']) ? (int) $result['severity'] : 0];// . ' ' . $class;

    // Output table row(s)
    if (!empty($result['description'])) {
      $output .= '<tr class="' . $class . ' merge-down"><td>' . $result['title'] . '</td><td>' . $result['value'] . '</td></tr>';
      $output .= '<tr class="' . $class . ' merge-up"><td colspan="2">' . $result['description'] . '</td></tr>';
    }
    else {
      $output .= '<tr class="' . $class . '"><td>' . $result['title'] . '</td><td>' . $result['value'] . '</td></tr>';
    }
  }

  $output .= '</table>';
  return $output;
}

/**
 * Menu callback: displays the Mediamosa status report.
 */
function _mediamosa_maintenance_status_status() {
  $output = '';

  // If we are set as Home page, the breadcrumb isn't set, let's do it here.
  $breadcrumb = array();
  $breadcrumb[] = l(t('Home'), NULL);
  $breadcrumb[] = l(t('Administer'), 'admin');
  $breadcrumb[] = l(t('MediaMosa'), 'admin/mediamosa');
  drupal_set_breadcrumb($breadcrumb);

  // Check run-time requirements and status information.
  // False means the data should come from variable.
  $statuses = module_invoke_all('mediamosa_status_collect', FALSE);

  foreach ($statuses as $status) {
    $output .= theme('mediamosa_maintenance_status_report', array('table_name' => (is_array($status['title']) ? $status['title'][0] : $status['title']), 'results' => $status['results']));
  }

  $output .= t('Last run: @last_run. Current time: @current.', array('@last_run' => date('Y-m-d H:i:s', variable_get('mediamosa_status_last_time', 0)), '@current' => date('Y-m-d H:i:s')));

  return $output;
}

/**
 * Menu callback: displays the Mediamosa server status report.
 */
function _mediamosa_maintenance_status_server() {
  $output = '';

  $result = mediamosa_server::get_status_enabled_job_servers(array(
    mediamosa_server_db::SERVER_TYPE_DOWNLOAD,
    mediamosa_server_db::SERVER_TYPE_STILL,
    mediamosa_server_db::SERVER_TYPE_JOB_PROCESSOR,
    mediamosa_server_db::SERVER_TYPE_UPLOAD,
  ));

  foreach ($result as $response) {
    $output .= '<h1>' . mediamosa_unicode::strtoupper($response['enabled_server']['description']) . '</h1>';
    if (!empty($response['status']['server_status'])) {
      foreach ($response['status']['server_status'] as $status) {
        $output .= theme('mediamosa_maintenance_status_report', array('table_name' => (is_array($status['title']) ? $status['title'][0] : $status['title']), 'results' => $status['results']));
      }
    }
  }

  return $output;
}

/**
 * Menu callback: displays the Mediamosa job status report.
 */
function _mediamosa_maintenance_status_job() {
  $output = '';

  drupal_add_css(drupal_get_path('module', 'mediamosa_maintenance_status') . '/mediamosa_maintenance_status.css');

  // Jobhandler.

  $results = array();

  $results[] = array(
    'title' => l(t('Recently finished jobs'), 'admin/mediamosa/status/job/list/finished'),
    array('data' => '', 'class' => 'mediamosa-status-value'),
  );
  $results[] = array(
    'title' => l(t('All waiting jobs'), 'admin/mediamosa/status/job/list/waiting'),
    array('data' => _mediamosa_maintenance_status_waiting_job(), 'class' => 'mediamosa-status-value'),
  );
  $results[] = array(
    'title' => t('Analyse waiting jobs'),
    array('data' => _mediamosa_maintenance_status_waiting_job(mediamosa_job_db::JOB_TYPE_ANALYSE), 'class' => 'mediamosa-status-value'),
  );
  $results[] = array(
    'title' => t('Transcoding waiting jobs'),
    array('data' => _mediamosa_maintenance_status_waiting_job(mediamosa_job_db::JOB_TYPE_TRANSCODE), 'class' => 'mediamosa-status-value'),
  );
  $results[] = array(
    'title' => t('Still waiting jobs'),
    array('data' => _mediamosa_maintenance_status_waiting_job(mediamosa_job_db::JOB_TYPE_STILL), 'class' => 'mediamosa-status-value'),
  );
  $results[] = array(
    'title' => t('Upload waiting jobs'),
    array('data' => _mediamosa_maintenance_status_waiting_job(mediamosa_job_db::JOB_TYPE_UPLOAD), 'class' => 'mediamosa-status-value'),
  );

  $output .= t('Jobhandler');
  $output .= theme('mediamosa_maintenance_table', array('rows' => $results));


  // Get all the job server.

  // Types to check.
  $types = array(
    mediamosa_job_server_db::JOB_TYPE_ANALYSE,
    mediamosa_job_server_db::JOB_TYPE_TRANSCODE,
    mediamosa_job_server_db::JOB_TYPE_STILL,
  );

  // Build the server query.
  $query = mediamosa_db::db_select(mediamosa_server_db::TABLE_NAME, 's');
  $query->fields('s', array(mediamosa_server_db::NID, mediamosa_server_db::DESCRIPTION));
  $query->condition('s.' . mediamosa_server_db::SERVER_TYPE, mediamosa_server_db::SERVER_TYPE_JOB_PROCESSOR);
  $result = $query->execute();

  foreach ($result as $row) {
    // Build the job query.
    $result_job = mediamosa_db::db_query("
      SELECT j.job_type, COUNT(*)
      FROM #mediamosa_server_job AS s
      INNER JOIN #mediamosa_job_server AS j USING (#job_id)
      WHERE s.#server_id = :server_id AND j.#job_type IN (:job_type)
      GROUP BY j.#job_type
      ORDER BY j.#job_type
    ", array(
      '#mediamosa_server_job' => mediamosa_server_job_db::TABLE_NAME,
      '#mediamosa_job_server' => mediamosa_job_server_db::TABLE_NAME,
      '#job_id' => mediamosa_server_job_db::JOB_ID,
      '#server_id' => mediamosa_server_job_db::SERVER_ID,
      '#job_type' => mediamosa_job_server_db::JOB_TYPE,
      ':server_id' => $row[mediamosa_server_db::NID],
      ':job_type' => $types,
    ))->fetchAllKeyed();
    // Collect the result for the theme_table.
    $result_job_array = array();
    foreach ($types as $key) {
      $result_job_array[] = array(
        'title' => mediamosa_unicode::strtolower($key),
        array('data' => (isset($result_job[$key]) ? $result_job[$key] : '0'), 'class' => 'mediamosa-status-value'),
      );
    }
    // Title of the table.
    $output .= $row[mediamosa_server_db::DESCRIPTION];
    // Create table.
    $output .= theme('mediamosa_maintenance_table', array('rows' => $result_job_array));
  }

  return $output;
}

/**
 * Job list. Menu callback.
 */
function _mediamosa_maintenance_status_job_list() {
  $output = array();

  // Path is eg. admin/mediamosa/status/job/list/finished. Then the $type is 'finished'.
  $type = mediamosa_unicode::strtoupper(arg(5));

  switch ($type) {
    case mediamosa_job_db::JOB_STATUS_FINISHED:
      $filter = _mediamosa_maintenance_status_build_filter_query();
      $output['job_header'] = array('#markup' => t('Recently finished jobs'));
      $output['job_filter_form'] = drupal_get_form('_mediamosa_maintenance_status_filter_form');
      break;
    case mediamosa_job_db::JOB_STATUS_WAITING:
      $output['job_header'] = array('#markup' => t('All waiting jobs'));
      break;
    default:
      $output['job_header'] = array('#markup' => t('Unknown job'));
      return $output;
      break;
  }

  $rows = array();

  $header = array(
    array('data' => t('Finished'), 'field' => 'j.' . mediamosa_job_db::FINISHED, 'sort' => 'desc'),
    array('data' => t('Job id'), 'field' => 'j.' . mediamosa_job_db::ID),
    array('data' => t('App id'), 'field' => 'j.' . mediamosa_job_db::APP_ID),
    array('data' => t('Asset id'), 'field' => 'j.' . mediamosa_job_db::ASSET_ID),
    array('data' => t('Mediafile id'), 'field' => 'j.' . mediamosa_job_db::MEDIAFILE_ID),
    array('data' => t('Owner'), 'field' => 'j.' . mediamosa_job_db::OWNER_ID),
    array('data' => t('Status'), 'field' => 'j.' . mediamosa_job_db::JOB_STATUS),
    array('data' => t('Progress'), 'field' => 'j.' . mediamosa_job_db::PROGRESS),
    array('data' => t('Priority'), 'field' => 'j.' . mediamosa_job_db::PRIORITY),
    array('data' => t('Job type'), 'field' => 'j.' . mediamosa_job_db::JOB_TYPE),
    array('data' => t('Started'), 'field' => 'j.' . mediamosa_job_db::STARTED),
    array('data' => t('Create still'), 'field' => 'j.' . mediamosa_job_db::CREATE_STILL),
    array('data' => t('No hint'), 'field' => 'j.' . mediamosa_job_db::NO_HINT),
    array('data' => t('Still parameters'), 'field' => 'j.' . mediamosa_job_db::STILL_PARAMETERS),
    array('data' => t('Error desc.'), 'field' => 'j.' . mediamosa_job_db::ERROR_DESCRIPTION),
    array('data' => t('Created'), 'field' => 'j.' . mediamosa_job_db::CREATED),
    array('data' => t('Changed'), 'field' => 'j.' . mediamosa_job_db::CHANGED),
    array('data' => t('Trans. profile id'), 'field' => 't.' . mediamosa_job_transcode_db::TRANSCODE_PROFILE_ID),
    array('data' => t('Tool'), 'field' => 't.' . mediamosa_job_transcode_db::TOOL),
    array('data' => t('Command'), 'field' => 't.' . mediamosa_job_transcode_db::COMMAND),
    //t('Message'),
    //array('data' => t('Operations')),
  );

  $query = db_select(mediamosa_job_db::TABLE_NAME, 'j')->extend('PagerDefault')->extend('TableSort');
  $query->leftJoin(mediamosa_job_transcode_db::TABLE_NAME, 't', 'j.' . mediamosa_job_db::ID . ' = t.' . mediamosa_job_transcode_db::JOB_ID);
  $query
    ->fields('j', array(
      mediamosa_job_db::FINISHED,
      mediamosa_job_db::ID,
      mediamosa_job_db::APP_ID,
      mediamosa_job_db::ASSET_ID,
      mediamosa_job_db::MEDIAFILE_ID,
      mediamosa_job_db::OWNER_ID,
      mediamosa_job_db::JOB_STATUS,
      mediamosa_job_db::PROGRESS,
      mediamosa_job_db::PRIORITY,
      mediamosa_job_db::JOB_TYPE,
      mediamosa_job_db::STARTED,
      mediamosa_job_db::CREATE_STILL,
      mediamosa_job_db::NO_HINT,
      mediamosa_job_db::STILL_PARAMETERS,
      mediamosa_job_db::ERROR_DESCRIPTION,
      mediamosa_job_db::CREATED,
      mediamosa_job_db::CHANGED,
    ))
    ->fields('t', array(
      mediamosa_job_transcode_db::TRANSCODE_PROFILE_ID,
      mediamosa_job_transcode_db::TOOL,
      mediamosa_job_transcode_db::COMMAND,
    ))
  ;
  if (!empty($filter['where'])) {
    $query->where($filter['where'], $filter['args']);
  }
  $result = $query
    ->condition('j.' . mediamosa_job_db::JOB_STATUS, mediamosa_job_db::JOB_STATUS_WAITING,
      ($type == mediamosa_job_db::JOB_STATUS_WAITING ? '=' : '<>')
    )
    ->limit(50)
    ->orderByHeader($header)
    ->execute();

  foreach ($result as $job) {
    $rows[] = array('data' =>
      array(
        $job->{mediamosa_job_db::FINISHED},
        $job->{mediamosa_job_db::ID},
        $job->{mediamosa_job_db::APP_ID},
        l($job->{mediamosa_job_db::ASSET_ID}, 'admin/mediamosa/browse/asset/' . $job->{mediamosa_job_db::ASSET_ID}),
        $job->{mediamosa_job_db::MEDIAFILE_ID},
        $job->{mediamosa_job_db::OWNER_ID},
        $job->{mediamosa_job_db::JOB_STATUS},
        $job->{mediamosa_job_db::PROGRESS},
        $job->{mediamosa_job_db::PRIORITY},
        $job->{mediamosa_job_db::JOB_TYPE},
        $job->{mediamosa_job_db::STARTED},
        $job->{mediamosa_job_db::CREATE_STILL},
        $job->{mediamosa_job_db::NO_HINT},
        $job->{mediamosa_job_db::STILL_PARAMETERS},
        $job->{mediamosa_job_db::ERROR_DESCRIPTION},
        $job->{mediamosa_job_db::CREATED},
        $job->{mediamosa_job_db::CHANGED},
        $job->{mediamosa_job_transcode_db::TRANSCODE_PROFILE_ID},
        $job->{mediamosa_job_transcode_db::TOOL},
        (
          $job->{mediamosa_job_db::JOB_TYPE} == mediamosa_job_db::JOB_TYPE_TRANSCODE ?
          $job->{mediamosa_job_transcode_db::COMMAND} :
          t('*** Not a transcode job ***')
        ),
      ),
    );
  }

  $output['job_table'] = array(
    '#theme' => 'table',
    '#header' => $header,
    '#rows' => $rows,
    '#attributes' => array('id' => 'admin-joblog'),
    '#empty' => t('No jobs available.'),
  );
  $output['job_pager'] = array('#theme' => 'pager');

  return $output;
}


/**
 * Job filter form.
 *
 * @ingroup forms
 * @see _mediamosa_maintenance_status_filter_form_submit()
 * @see _mediamosa_maintenance_status_filter_form_validate()
 */
function _mediamosa_maintenance_status_filter_form($form) {
  $filters = _mediamosa_maintenance_status_filters();

  $form['filters'] = array(
    '#type' => 'fieldset',
    '#title' => t('Filter jobs'),
    '#collapsible' => TRUE,
    '#collapsed' => empty($_SESSION['mm_status_job_filter']),
  );
  foreach ($filters as $key => $filter) {
    $form['filters']['status'][$key] = array(
      '#title' => $filter['title'],
      '#type' => 'select',
      '#multiple' => TRUE,
      '#size' => 8,
      '#options' => $filter['options'],
    );
    if (!empty($_SESSION['mm_status_job_filter'][$key])) {
      $form['filters']['status'][$key]['#default_value'] = $_SESSION['mm_status_job_filter'][$key];
    }
  }

  $form['filters']['actions'] = array(
    '#type' => 'actions',
    '#attributes' => array('class' => array('container-inline')),
  );
  $form['filters']['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Filter'),
  );
  if (!empty($_SESSION['mm_status_job_filter'])) {
    $form['filters']['actions']['reset'] = array(
      '#type' => 'submit',
      '#value' => t('Reset')
    );
  }

  return $form;
}

/**
 * Validate result from job administration filter form.
 */
function _mediamosa_maintenance_status_filter_form_validate($form, &$form_state) {
  if ($form_state['values']['op'] == t('Filter') && empty($form_state['values']['type']) && empty($form_state['values']['severity'])) {
    form_set_error('type', t('You must select something to filter by.'));
  }
}

/**
 * Process result from job administration filter form.
 */
function _mediamosa_maintenance_status_filter_form_submit($form, &$form_state) {
  $op = $form_state['values']['op'];
  $filters = _mediamosa_maintenance_status_filters();
  switch ($op) {
    case t('Filter'):
      foreach ($filters as $name => $filter) {
        if (isset($form_state['values'][$name])) {
          $_SESSION['mm_status_job_filter'][$name] = $form_state['values'][$name];
        }
      }
      break;

    case t('Reset'):
      $_SESSION['mm_status_job_filter'] = array();
      break;
  }
  //return 'admin/mediamosa/status/job/list/' . $type;
}


/**
 * Build query for job administration filters based on session.
 */
function _mediamosa_maintenance_status_build_filter_query() {
  if (empty($_SESSION['mm_status_job_filter'])) {
    return;
  }

  $filters = _mediamosa_maintenance_status_filters();

  // Build query
  $where = $args = array();
  foreach ($_SESSION['mm_status_job_filter'] as $key => $filter) {
    $filter_where = array();
    foreach ($filter as $value) {
      $filter_where[] = $filters[$key]['where'] . $filters[$key]['placeholder'];
      $args[$filters[$key]['placeholder']] = $value;
    }
    if (!empty($filter_where)) {
      $where[] = '(' . implode(' OR ', $filter_where) . ')';
    }
  }
  $where = !empty($where) ? implode(' AND ', $where) : '';

  return array(
    'where' => $where,
    'args' => $args,
  );
}

/**
 * List dblog administration filters that can be applied.
 */
function _mediamosa_maintenance_status_filters() {
  $filters = array();

  $statuses = array(
    mediamosa_job_db::JOB_STATUS_CANCELLED,
    mediamosa_job_db::JOB_STATUS_CANCELLING,
    mediamosa_job_db::JOB_STATUS_FAILED,
    mediamosa_job_db::JOB_STATUS_FINISHED,
    mediamosa_job_db::JOB_STATUS_INPROGRESS,
    //mediamosa_job_db::JOB_STATUS_WAITING,
  );

  foreach ($statuses as $type) {
    $types[$type] = $type;
  }

  if (!empty($types)) {
    $filters['type'] = array(
      'title' => t('Type'),
      'where' => "j." . mediamosa_job_db::JOB_STATUS . " = ",
      'placeholder' => ':filter_status',
      'options' => $types,
    );
  }

  return $filters;
}


/**
 * Get the waiting jobs.
 *
 * @param $type
 *   Type of the waiting job.
 */
function _mediamosa_maintenance_status_waiting_job($type = NULL) {
  $query = mediamosa_db::db_select(mediamosa_job_db::TABLE_NAME, 'j');
  $query->fields('j');
  $query->condition('j.' . mediamosa_job_db::JOB_STATUS, mediamosa_job_db::JOB_STATUS_WAITING);
  if (!is_null($type)) {
    $query->condition('j.' . mediamosa_job_db::JOB_TYPE, $type);
  }
  $count = $query->countQuery()->execute()->fetchField();

  return $count;
}

/**
 * Give back result ok or warning.
 *
 * @param $test boolean
 */
function _mediamosa_maintenance_status_okwarning($test) {
  return $test ? MEDIAMOSA_MAINTENANCE_STATUS_RESULT_WARNING : MEDIAMOSA_MAINTENANCE_STATUS_RESULT_OK;
}

/**
 * Give back result ok or error.
 *
 * @param $test boolean
 */
function _mediamosa_maintenance_status_okerror($test) {
  return $test ? MEDIAMOSA_MAINTENANCE_STATUS_RESULT_ERROR : MEDIAMOSA_MAINTENANCE_STATUS_RESULT_OK;
}

/**
 * Search a string in the values of an array with strpos(). Case insensitive.
 *
 * @param $text string
 * @param $container array
 *
 * @return
 *   string, the array value where the text exists, or an empty string
 */
function _mediamosa_maintenance_status_search_in_array($text, array $container) {
  $value = '';
  if (is_array($container) && !empty($container)) {
    foreach ($container as $container_value) {
      if (strpos(drupal_strtolower($container_value), drupal_strtolower($text)) !== FALSE) {
        $value = $container_value;
        break;
      }
    }
  }
  return $value;
}

