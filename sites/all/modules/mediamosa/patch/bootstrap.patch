Index: bootstrap.inc
===================================================================
--- a/includes/bootstrap.inc	Tue Apr 06 01:00:52 2010 +0200
+++ b/includes/bootstrap.inc	Wed Apr 07 12:33:07 2010 +0200
@@ -601,17 +601,23 @@
     }
   }
   // Strip leading periods, www., and port numbers from cookie domain.
-  // Strip leading periods, www., and port numbers from cookie domain.
+
+  // Strip leading periods, and port numbers from cookie domain.
   $cookie_domain = ltrim($cookie_domain, '.');
-  if (strpos($cookie_domain, 'www.') === 0) {
-    $cookie_domain = substr($cookie_domain, 4);
-  }
-  $cookie_domain = explode(':', $cookie_domain);
-  $cookie_domain = '.' . $cookie_domain[0];
+  $cookie_domain = array_shift(explode(":", $cookie_domain, 2));
+
   // Per RFC 2109, cookie domains must contain at least one dot other than the
   // first. For hosts such as 'localhost' or IP Addresses we don't set a cookie domain.
+  // todo: how about co.uk type of domains?
   if (count(explode('.', $cookie_domain)) > 2 && !is_numeric(str_replace('.', '', $cookie_domain))) {
+    // remove first part before the dot and replace by a dot only
+    $cookie_domain = explode(".", $cookie_domain, 2);
+    array_shift($cookie_domain);
+    $cookie_domain = ".". implode($cookie_domain);
+
     ini_set('session.cookie_domain', $cookie_domain);
   }
+
   // To prevent session cookies from being hijacked, a user can configure the
   // SSL version of their website to only transfer session cookies via SSL by
   // using PHP's session.cookie_secure setting. The browser will then use two
@@ -1994,7 +1994,7 @@
   // the database is not yet initialized and we can't access any Drupal variables.
   // The file properties add more entropy not easily accessible to others.
   $filepath = DRUPAL_ROOT . '/includes/bootstrap.inc';
-  $key = sha1(serialize($databases) . filectime($filepath) . fileinode($filepath), TRUE);
+  $key = sha1(serialize($databases) /*. filectime($filepath) . fileinode($filepath)*/, TRUE);
   // The HMAC must match.
   return $hmac == base64_encode(hash_hmac('sha1', $check_string, $key, TRUE));
 }
@@ -2011,7 +2011,7 @@
     // check the HMAC before the database is initialized. filectime()
     // and fileinode() are not easily determined from remote.
     $filepath = DRUPAL_ROOT . '/includes/bootstrap.inc';
-    $key = sha1(serialize($databases) . filectime($filepath) . fileinode($filepath), TRUE);
+    $key = sha1(serialize($databases) /*. filectime($filepath) . fileinode($filepath)*/, TRUE);
   }
    // Generate a moderately secure HMAC based on the database credentials.
    $salt = uniqid('', TRUE);
